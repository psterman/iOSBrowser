//
//  ChatView.swift
//  iOSBrowser
//
//  Created by LZH on 2025/7/20.
//

import SwiftUI

struct ChatView: View {
    let contact: AIContact
    let onBack: () -> Void    @State private var messageText = ""
    @State private var messages: [ChatMessage] = []
    @State private var isLoading = false
    @Environment(\.presentationMode) var presentationMode
    @ObservedObject private var hotTrendsManager = MockHotTrendsManager.shared
    @StateObject private var apiManager = APIConfigManager.shared

    // æ£€æŸ¥æ˜¯å¦ä¸ºå¹³å°è”ç³»äºº
    private var isPlatformContact: Bool {
        contact.supportedFeatures.contains(.hotTrends)
    }
    
    var body: some View {
        VStack(spacing: 0) {
            if isPlatformContact {
                // å¹³å°çƒ­æ¦œç•Œé¢
                PlatformHotTrendsContentView(contact: contact)
            } else {
                // ä¼ ç»ŸAIèŠå¤©ç•Œé¢
                TraditionalChatView()
            }
        }
        .navigationTitle(contact.name)
        .navigationBarBackButtonHidden(true)
        .navigationBarItems(leading: Button(action: onBack) {
            HStack(spacing: 4) {
                Image(systemName: "chevron.left")
                Text("è¿”å›")
            }
            .foregroundColor(.blue)
        })        .navigationBarTitleDisplayMode(.inline)
        .onAppear {
            initializeContent()
        }
    }

    // ä¼ ç»ŸAIèŠå¤©ç•Œé¢
    private func TraditionalChatView() -> some View {
        VStack(spacing: 0) {
            // èŠå¤©æ¶ˆæ¯åˆ—è¡¨
            ScrollView {
                LazyVStack(spacing: 12) {
                    ForEach(messages) { message in
                        ChatMessageRow(message: message)
                    }

                    if isLoading {
                        HStack {
                            Spacer()
                            ProgressView()
                                .scaleEffect(0.8)
                            Text("AIæ­£åœ¨æ€è€ƒ...")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            Spacer()
                        }
                        .padding()
                    }
                }
                .padding(.horizontal, 16)
                .padding(.top, 8)
            }
            
            Divider()

            // è¾“å…¥åŒºåŸŸ
            HStack(spacing: 12) {
                TextField("è¾“å…¥æ¶ˆæ¯...", text: $messageText, axis: .vertical)
                    .textFieldStyle(RoundedBorderTextFieldStyle())
                    .lineLimit(1...4)

                Button(action: sendMessage) {
                    Image(systemName: "paperplane.fill")
                        .foregroundColor(messageText.isEmpty ? .gray : .blue)
                        .font(.title2)
                }
                .disabled(messageText.isEmpty || isLoading)
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
        }
    }

    private func initializeContent() {
        if isPlatformContact {
            // å¹³å°è”ç³»äººï¼šåˆå§‹åŒ–çƒ­æ¦œæ•°æ®å’Œæ¬¢è¿æ¶ˆæ¯
            loadHistoryMessages()
            if messages.isEmpty {
                addPlatformWelcomeMessage()
            }
            hotTrendsManager.refreshHotTrends(for: contact.id)
        } else {
            // AIè”ç³»äººï¼šåŠ è½½å†å²è®°å½•
            loadHistoryMessages()
            if messages.isEmpty {
                // åªæœ‰åœ¨æ²¡æœ‰å†å²è®°å½•æ—¶æ‰æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                messages.append(ChatMessage(
                    id: UUID().uuidString,
                    content: "ä½ å¥½ï¼æˆ‘æ˜¯\(contact.name)ï¼Œ\(contact.description)ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
                    isFromUser: false,
                    timestamp: Date(),
                    status: .sent,
                    actions: [],
                    isHistorical: false,
                    aiSource: contact.name
                ))
                saveHistoryMessages()
            }
        }
    }

    // MARK: - å†å²è®°å½•ç®¡ç†

    private func loadHistoryMessages() {
        let key = "chat_history_\(contact.id)"
        if let data = UserDefaults.standard.data(forKey: key),
           let savedMessages = try? JSONDecoder().decode([ChatMessage].self, from: data) {
            messages = savedMessages
            print("ğŸ“š åŠ è½½äº† \(savedMessages.count) æ¡å†å²æ¶ˆæ¯ for \(contact.name)")
        } else {
            messages = []
            print("ğŸ“š æ²¡æœ‰æ‰¾åˆ° \(contact.name) çš„å†å²æ¶ˆæ¯")
        }
    }

    private func saveHistoryMessages() {
        let key = "chat_history_\(contact.id)"
        print("ğŸ’¾ å°è¯•ä¿å­˜å†å²è®°å½•ï¼Œkey: \(key)")
        print("ğŸ’¾ å½“å‰æ¶ˆæ¯æ•°é‡: \(messages.count)")

        if let data = try? JSONEncoder().encode(messages) {
            UserDefaults.standard.set(data, forKey: key)
            UserDefaults.standard.synchronize() // å¼ºåˆ¶åŒæ­¥
            print("âœ… æˆåŠŸä¿å­˜äº† \(messages.count) æ¡æ¶ˆæ¯ for \(contact.name)")

            // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
            if let savedData = UserDefaults.standard.data(forKey: key),
               let savedMessages = try? JSONDecoder().decode([ChatMessage].self, from: savedData) {
                print("âœ… éªŒè¯ä¿å­˜æˆåŠŸï¼Œè¯»å–åˆ° \(savedMessages.count) æ¡æ¶ˆæ¯")
            } else {
                print("âŒ éªŒè¯ä¿å­˜å¤±è´¥ï¼Œæ— æ³•è¯»å–ä¿å­˜çš„æ¶ˆæ¯")
            }
        } else {
            print("âŒ ä¿å­˜æ¶ˆæ¯å¤±è´¥ for \(contact.name) - JSONç¼–ç å¤±è´¥")
        }
    }

    // æ·»åŠ å¹³å°æ¬¢è¿æ¶ˆæ¯
    private func addPlatformWelcomeMessage() {
        let welcomeMessage = ChatMessage(
            id: UUID().uuidString,
            content: "æ¬¢è¿æ¥åˆ°\(contact.name)ï¼\n\næˆ‘ä¼šä¸ºæ‚¨æ¨é€æœ€æ–°çš„çƒ­é—¨å†…å®¹å’Œèµ„è®¯ã€‚æ‚¨å¯ä»¥ï¼š\n\nâ€¢ æŸ¥çœ‹å®æ—¶çƒ­æ¦œ\nâ€¢ æµè§ˆçƒ­é—¨è¯é¢˜\nâ€¢ ç‚¹å‡»å†…å®¹æŸ¥çœ‹è¯¦æƒ…\n\næ­£åœ¨ä¸ºæ‚¨è·å–æœ€æ–°çƒ­æ¦œ...",
            isFromUser: false,
            timestamp: Date(),
            status: .sent,
            actions: [
                MessageAction(id: "refresh", title: "åˆ·æ–°çƒ­æ¦œ", type: .refresh),
                MessageAction(id: "settings", title: "è®¾ç½®", type: .settings)
            ]
        )
        messages.append(welcomeMessage)
    }

    // å¹³å°ç‰¹å®šçš„æ¶ˆæ¯å‘é€é€»è¾‘
    private func sendPlatformMessage() {
        guard !messageText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty else { return }

        let userMessage = ChatMessage(
            id: UUID().uuidString,
            content: messageText,
            isFromUser: true,
            timestamp: Date(),
            status: .sent,
            actions: []
        )

        messages.append(userMessage)
        let currentMessage = messageText.lowercased()
        messageText = ""
        isLoading = true

        // æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆå¹³å°ç‰¹å®šçš„å“åº”
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
            let response = generatePlatformResponse(for: currentMessage)
            messages.append(response)
            isLoading = false

            // å¦‚æœç”¨æˆ·è¯·æ±‚çƒ­æ¦œï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®
            if currentMessage.contains("çƒ­æ¦œ") || currentMessage.contains("æœ€æ–°") || currentMessage.contains("åˆ·æ–°") {
                hotTrendsManager.refreshHotTrends(for: contact.id)
            }
        }
    }

    // ç”Ÿæˆå¹³å°ç‰¹å®šçš„å“åº”
    private func generatePlatformResponse(for message: String) -> ChatMessage {
        var responseContent = ""
        var actions: [MessageAction] = []

        if message.contains("çƒ­æ¦œ") || message.contains("æœ€æ–°") {
            responseContent = "æ­£åœ¨ä¸ºæ‚¨è·å–\(contact.name)çš„æœ€æ–°çƒ­æ¦œå†…å®¹..."
            actions = [
                MessageAction(id: "view_hottrends", title: "æŸ¥çœ‹çƒ­æ¦œ", type: .viewContent),
                MessageAction(id: "refresh", title: "åˆ·æ–°", type: .refresh)
            ]
        } else if message.contains("å¸®åŠ©") || message.contains("åŠŸèƒ½") {
            responseContent = "æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹æœåŠ¡ï¼š\n\nğŸ“Š å®æ—¶çƒ­æ¦œæ¨é€\nğŸ”¥ çƒ­é—¨è¯é¢˜è¿½è¸ª\nğŸ“± ä¸€é”®è·³è½¬åˆ°åº”ç”¨\nğŸ”„ å®šæ—¶å†…å®¹æ›´æ–°\n\næ‚¨æƒ³äº†è§£å“ªä¸ªåŠŸèƒ½ï¼Ÿ"
            actions = [
                MessageAction(id: "view_hottrends", title: "æŸ¥çœ‹çƒ­æ¦œ", type: .viewContent),
                MessageAction(id: "settings", title: "è®¾ç½®", type: .settings)
            ]
        } else if message.contains("è®¾ç½®") || message.contains("é…ç½®") {
            responseContent = "æ‚¨å¯ä»¥è®¾ç½®ï¼š\n\nâ° æ¨é€é¢‘ç‡\nğŸ·ï¸ å…³æ³¨åˆ†ç±»\nğŸ”” é€šçŸ¥æé†’\n\néœ€è¦è°ƒæ•´å“ªé¡¹è®¾ç½®ï¼Ÿ"
            actions = [
                MessageAction(id: "settings", title: "æ‰“å¼€è®¾ç½®", type: .settings)
            ]
        } else {
            responseContent = "æˆ‘ç†è§£æ‚¨æƒ³äº†è§£\(message)ç›¸å…³çš„å†…å®¹ã€‚\n\nä½œä¸º\(contact.name)çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘ä¸“æ³¨äºä¸ºæ‚¨æä¾›æœ€æ–°çš„çƒ­é—¨èµ„è®¯å’Œè¯é¢˜ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹å½“å‰çƒ­æ¦œæˆ–å‘Šè¯‰æˆ‘æ‚¨æ„Ÿå…´è¶£çš„å†…å®¹ç±»å‹ã€‚"
            actions = [
                MessageAction(id: "view_hottrends", title: "æŸ¥çœ‹çƒ­æ¦œ", type: .viewContent),
                MessageAction(id: "refresh", title: "åˆ·æ–°å†…å®¹", type: .refresh)
            ]
        }

        return ChatMessage(
            id: UUID().uuidString,
            content: responseContent,
            isFromUser: false,
            timestamp: Date(),
            status: .sent,
            actions: actions,
            aiSource: contact.name
        )
    }
    
    private func sendMessage() {
        if isPlatformContact {
            sendPlatformMessage()
        } else {
            sendAIMessage()
        }
    }

    // ä¼ ç»ŸAIæ¶ˆæ¯å‘é€
    private func sendAIMessage() {
        guard !messageText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty else { return }

        let userMessage = ChatMessage(
            id: UUID().uuidString,
            content: messageText,
            isFromUser: true,
            timestamp: Date(),
            status: .sent,
            actions: [],
            isHistorical: false,
            aiSource: nil
        )

        messages.append(userMessage)
        saveHistoryMessages() // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯

        let currentMessage = messageText
        messageText = ""
        isLoading = true

        print("ğŸš€ å¼€å§‹è°ƒç”¨ \(contact.name) APIï¼Œæ¶ˆæ¯: \(currentMessage)")

        // å®é™…è°ƒç”¨AI API
        callAIAPI(message: currentMessage)
    }

    // è°ƒç”¨AI API - å®Œå…¨é‡å†™çš„é€»è¾‘
    private func callAIAPI(message: String) {
        print("ğŸ” å¼€å§‹APIè°ƒç”¨æ£€æŸ¥...")
        print("ğŸ” è”ç³»äººåç§°: '\(contact.name)'")
        print("ğŸ” è”ç³»äººID: '\(contact.id)'")

        // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥APIå¯†é’¥
        guard let apiKey = apiManager.getAPIKey(for: contact.id) else {
            print("âŒ æœªæ‰¾åˆ°APIå¯†é’¥é…ç½®")
            showAPIKeyMissingError()
            return
        }

        guard !apiKey.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty else {
            print("âŒ APIå¯†é’¥ä¸ºç©º")
            showAPIKeyMissingError()
            return
        }

        print("âœ… æ‰¾åˆ°APIå¯†é’¥: \(apiKey.prefix(10))...")

        // ç¬¬äºŒæ­¥ï¼šæ ¹æ®è”ç³»äººIDè°ƒç”¨å¯¹åº”çš„API
        print("ğŸ¯ å¼€å§‹è·¯ç”±åˆ°å…·ä½“çš„APIæœåŠ¡...")

        if contact.id == "deepseek" {
            print("ğŸ¯ ç¡®è®¤è°ƒç”¨DeepSeek API")
            callDeepSeekAPIDirectly(message: message, apiKey: apiKey)
        } else if contact.id == "openai" {
            print("ğŸ¯ ç¡®è®¤è°ƒç”¨OpenAI API")
            callOpenAIAPI(message: message, apiKey: apiKey)
        } else {
            print("âŒ æœªçŸ¥çš„AIæœåŠ¡: \(contact.id)")
            showUnsupportedServiceError()
        }
    }

    // æ˜¾ç¤ºAPIå¯†é’¥ç¼ºå¤±é”™è¯¯
    private func showAPIKeyMissingError() {
        DispatchQueue.main.async {
            let errorResponse = ChatMessage(
                id: UUID().uuidString,
                content: "âŒ æœªé…ç½®APIå¯†é’¥\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š\n1. ç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®\n2. æ‰¾åˆ°\(self.contact.name)é…ç½®\n3. è¾“å…¥æœ‰æ•ˆçš„APIå¯†é’¥\n4. ä¿å­˜åé‡æ–°å°è¯•",
                isFromUser: false,
                timestamp: Date(),
                status: .sent,
                actions: [],
                isHistorical: false,
                aiSource: self.contact.name
            )
            self.messages.append(errorResponse)
            self.saveHistoryMessages()
            self.isLoading = false
        }
    }

    // æ˜¾ç¤ºä¸æ”¯æŒçš„æœåŠ¡é”™è¯¯
    private func showUnsupportedServiceError() {
        DispatchQueue.main.async {
            let errorResponse = ChatMessage(
                id: UUID().uuidString,
                content: "âŒ æš‚ä¸æ”¯æŒçš„AIæœåŠ¡\n\nå½“å‰ä»…æ”¯æŒï¼š\nâ€¢ DeepSeek\nâ€¢ OpenAI\n\nè¯·é€‰æ‹©æ”¯æŒçš„AIæœåŠ¡è¿›è¡Œå¯¹è¯ã€‚",
                isFromUser: false,
                timestamp: Date(),
                status: .sent,
                actions: [],
                isHistorical: false,
                aiSource: self.contact.name
            )
            self.messages.append(errorResponse)
            self.saveHistoryMessages()
            self.isLoading = false
        }
    }
    
    // MARK: - APIè°ƒç”¨å‡½æ•°

    // DeepSeek APIç›´æ¥è°ƒç”¨ - ç»ä¸ä½¿ç”¨æ¨¡æ¿å“åº”
    private func callDeepSeekAPIDirectly(message: String, apiKey: String) {
        print("ğŸš€ å¼€å§‹DeepSeek APIç›´æ¥è°ƒç”¨")
        print("ğŸ”‘ APIå¯†é’¥: \(apiKey.prefix(10))...")
        print("ğŸ“ ç”¨æˆ·æ¶ˆæ¯: \(message)")

        // DeepSeek APIç«¯ç‚¹
        guard let url = URL(string: "https://api.deepseek.com/v1/chat/completions") else {
            print("âŒ APIç«¯ç‚¹URLæ— æ•ˆ")
            showAPIError("APIç«¯ç‚¹é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»å¼€å‘è€…")
            return
        }

        print("ğŸŒ APIç«¯ç‚¹: \(url.absoluteString)")

        // æ„å»ºè¯·æ±‚
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.addValue("application/json", forHTTPHeaderField: "Content-Type")
        request.addValue("Bearer \(apiKey)", forHTTPHeaderField: "Authorization")
        request.timeoutInterval = 30.0

        // è¯·æ±‚ä½“
        let requestBody: [String: Any] = [
            "model": "deepseek-chat",
            "messages": [
                [
                    "role": "user",
                    "content": message
                ]
            ],
            "stream": false,
            "max_tokens": 2000,
            "temperature": 0.7
        ]

        print("ğŸ“¤ è¯·æ±‚ä½“: \(requestBody)")

        // ç¼–ç è¯·æ±‚ä½“
        do {
            let jsonData = try JSONSerialization.data(withJSONObject: requestBody, options: [])
            request.httpBody = jsonData
            print("âœ… è¯·æ±‚ä½“ç¼–ç æˆåŠŸ")
        } catch {
            print("âŒ è¯·æ±‚ä½“ç¼–ç å¤±è´¥: \(error)")
            showAPIError("è¯·æ±‚ç¼–ç å¤±è´¥: \(error.localizedDescription)")
            return
        }

        print("ğŸŒ å‘é€ç½‘ç»œè¯·æ±‚...")

        // å‘é€è¯·æ±‚
        URLSession.shared.dataTask(with: request) { [weak self] data, response, error in
            print("ğŸ“¥ æ”¶åˆ°ç½‘ç»œå“åº”")

            DispatchQueue.main.async {
                self?.isLoading = false

                // æ£€æŸ¥ç½‘ç»œé”™è¯¯
                if let error = error {
                    print("âŒ ç½‘ç»œé”™è¯¯: \(error.localizedDescription)")
                    self?.showAPIError("ç½‘ç»œè¿æ¥å¤±è´¥: \(error.localizedDescription)\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•")
                    return
                }

                // æ£€æŸ¥HTTPå“åº”
                guard let httpResponse = response as? HTTPURLResponse else {
                    print("âŒ æ— æ•ˆçš„HTTPå“åº”")
                    self?.showAPIError("æœåŠ¡å™¨å“åº”æ— æ•ˆ")
                    return
                }

                print("ğŸ“Š HTTPçŠ¶æ€ç : \(httpResponse.statusCode)")

                // æ£€æŸ¥å“åº”æ•°æ®
                guard let data = data else {
                    print("âŒ å“åº”æ•°æ®ä¸ºç©º")
                    self?.showAPIError("æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®")
                    return
                }

                print("ğŸ“„ å“åº”æ•°æ®å¤§å°: \(data.count) bytes")

                // è§£æå“åº”
                self?.parseDeepSeekAPIResponse(data: data, statusCode: httpResponse.statusCode)
            }
        }.resume()
    }

    // è§£æDeepSeek APIå“åº”
    private func parseDeepSeekAPIResponse(data: Data, statusCode: Int) {
        print("ğŸ” å¼€å§‹è§£æDeepSeek APIå“åº”")

        // å…ˆæ‰“å°åŸå§‹å“åº”
        if let responseString = String(data: data, encoding: .utf8) {
            print("ğŸ“„ åŸå§‹å“åº”: \(responseString)")
        }

        // æ£€æŸ¥HTTPçŠ¶æ€ç 
        if statusCode != 200 {
            print("âŒ HTTPé”™è¯¯çŠ¶æ€ç : \(statusCode)")
            if let responseString = String(data: data, encoding: .utf8) {
                showAPIError("APIè°ƒç”¨å¤±è´¥ (çŠ¶æ€ç : \(statusCode))\n\nå“åº”: \(responseString)")
            } else {
                showAPIError("APIè°ƒç”¨å¤±è´¥ (çŠ¶æ€ç : \(statusCode))")
            }
            return
        }

        // è§£æJSON
        do {
            guard let json = try JSONSerialization.jsonObject(with: data) as? [String: Any] else {
                print("âŒ JSONæ ¼å¼æ— æ•ˆ")
                showAPIError("æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯")
                return
            }

            print("âœ… JSONè§£ææˆåŠŸ")

            // æ£€æŸ¥APIé”™è¯¯
            if let error = json["error"] as? [String: Any] {
                let errorMessage = error["message"] as? String ?? "æœªçŸ¥é”™è¯¯"
                let errorType = error["type"] as? String ?? "unknown"
                print("âŒ APIè¿”å›é”™è¯¯: \(errorMessage) (ç±»å‹: \(errorType))")
                showAPIError("DeepSeek APIé”™è¯¯: \(errorMessage)")
                return
            }

            // æå–AIå›å¤
            guard let choices = json["choices"] as? [[String: Any]],
                  let firstChoice = choices.first,
                  let message = firstChoice["message"] as? [String: Any],
                  let content = message["content"] as? String else {
                print("âŒ å“åº”æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æå–AIå›å¤")
                showAPIError("å“åº”æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æå–AIå›å¤å†…å®¹")
                return
            }

            let aiContent = content.trimmingCharacters(in: .whitespacesAndNewlines)
            print("âœ… æˆåŠŸæå–AIå›å¤: \(aiContent.prefix(50))...")

            // åˆ›å»ºAIå›å¤æ¶ˆæ¯
            let aiResponse = ChatMessage(
                id: UUID().uuidString,
                content: aiContent,
                isFromUser: false,
                timestamp: Date(),
                status: .sent,
                actions: [],
                isHistorical: false,
                aiSource: "DeepSeek"
            )

            // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
            self.messages.append(aiResponse)
            self.saveHistoryMessages()

            print("âœ… DeepSeek APIè°ƒç”¨å®Œå…¨æˆåŠŸ")

        } catch {
            print("âŒ JSONè§£æå¤±è´¥: \(error)")
            showAPIError("å“åº”è§£æå¤±è´¥: \(error.localizedDescription)")
        }
    }

    // æ˜¾ç¤ºAPIé”™è¯¯
    private func showAPIError(_ errorMessage: String) {
        print("âŒ æ˜¾ç¤ºAPIé”™è¯¯: \(errorMessage)")

        let errorResponse = ChatMessage(
            id: UUID().uuidString,
            content: "âŒ APIè°ƒç”¨å¤±è´¥\n\n\(errorMessage)\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ APIå¯†é’¥æ˜¯å¦æ­£ç¡®\nâ€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\nâ€¢ APIé¢åº¦æ˜¯å¦å……è¶³",
            isFromUser: false,
            timestamp: Date(),
            status: .sent,
            actions: [],
            isHistorical: false,
            aiSource: self.contact.name
        )

        self.messages.append(errorResponse)
        self.saveHistoryMessages()
    }

    // OpenAI APIè°ƒç”¨
    private func callOpenAIAPI(message: String, apiKey: String) {
        guard let url = URL(string: "https://api.openai.com/v1/chat/completions") else {
            handleAPIError("æ— æ•ˆçš„APIç«¯ç‚¹")
            return
        }

        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.addValue("application/json", forHTTPHeaderField: "Content-Type")
        request.addValue("Bearer \(apiKey)", forHTTPHeaderField: "Authorization")

        let requestBody: [String: Any] = [
            "model": "gpt-4",
            "messages": [
                ["role": "user", "content": message]
            ]
        ]

        do {
            request.httpBody = try JSONSerialization.data(withJSONObject: requestBody)
        } catch {
            handleAPIError("è¯·æ±‚æ•°æ®ç¼–ç å¤±è´¥")
            return
        }

        URLSession.shared.dataTask(with: request) { [weak self] data, response, error in
            DispatchQueue.main.async {
                self?.isLoading = false

                if let error = error {
                    self?.handleAPIError("ç½‘ç»œé”™è¯¯: \(error.localizedDescription)")
                    return
                }

                guard let data = data else {
                    self?.handleAPIError("æœªæ”¶åˆ°å“åº”æ•°æ®")
                    return
                }

                self?.parseOpenAIResponse(data: data)
            }
        }.resume()
    }

    // å·²åˆ é™¤é€šç”¨APIè°ƒç”¨ - ä¸å†ä½¿ç”¨æ¨¡æ‹Ÿå“åº”

    // å·²åˆ é™¤Claudeå’ŒQwen APIè°ƒç”¨ - å½“å‰ä»…æ”¯æŒDeepSeekå’ŒOpenAI

    // å·²åˆ é™¤æ—§çš„å“åº”è§£æå‡½æ•° - ä½¿ç”¨æ–°çš„parseDeepSeekAPIResponse

    // å·²åˆ é™¤æ¨¡æ¿å“åº”å‡½æ•° - ä¸å†ä½¿ç”¨æ¨¡æ‹Ÿå›å¤
}

// MARK: - å¹³å°çƒ­æ¦œå†…å®¹è§†å›¾
struct PlatformHotTrendsContentView: View {
    let contact: AIContact
    let onBack: () -> Void    @ObservedObject private var hotTrendsManager = MockHotTrendsManager.shared
    @State private var selectedItem: HotTrendItem?
    @State private var showingItemDetail = false

    private var hotTrends: HotTrendsList? {
        hotTrendsManager.getHotTrends(for: contact.id)
    }

    var body: some View {
        VStack(spacing: 0) {
            // å¹³å°å¤´éƒ¨ä¿¡æ¯
            PlatformHeaderInfoView(contact: contact)

            // çƒ­æ¦œå†…å®¹
            if let trends = hotTrends, !trends.items.isEmpty {
                PlatformHotTrendsListView(
                    trends: trends,
                    onItemTap: { item in
                        selectedItem = item
                        handleItemTap(item)
                    }
                )
            } else if hotTrendsManager.isLoading[contact.id] == true {
                PlatformLoadingView()
            } else {
                PlatformEmptyStateView(contact: contact) {
                    hotTrendsManager.refreshHotTrends(for: contact.id)
                }
            }
        }
        .refreshable {
            hotTrendsManager.refreshHotTrends(for: contact.id)
        }
        .sheet(isPresented: $showingItemDetail) {
            if let item = selectedItem {
                PlatformItemDetailView(item: item, contact: contact)
            }
        }
    }

    private func handleItemTap(_ item: HotTrendItem) {
        print("ğŸ¯ ç‚¹å‡»çƒ­æ¦œé¡¹ç›®: \(item.title)")

        // å°è¯•æ‰“å¼€æ·±åº¦é“¾æ¥
        if let urlString = item.url, let url = URL(string: urlString) {
            if UIApplication.shared.canOpenURL(url) {
                UIApplication.shared.open(url)
                return
            }
        }

        // å¦‚æœæ·±åº¦é“¾æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦æƒ…é¡µé¢
        showingItemDetail = true
    }
}

// MARK: - å¹³å°å¤´éƒ¨ä¿¡æ¯è§†å›¾
struct PlatformHeaderInfoView: View {
    let contact: AIContact
    let onBack: () -> Void    @ObservedObject private var hotTrendsManager = MockHotTrendsManager.shared

    var body: some View {
        VStack(spacing: 12) {
            HStack(spacing: 16) {
                // å¹³å°å›¾æ ‡
                Image(systemName: contact.avatar)
                    .font(.system(size: 32))
                    .foregroundColor(contact.color)
                    .frame(width: 50, height: 50)
                    .background(contact.color.opacity(0.1))
                    .clipShape(Circle())

                VStack(alignment: .leading, spacing: 4) {
                    Text(contact.name)
                        .font(.title2)
                        .fontWeight(.bold)

                    Text(contact.description)
                        .font(.subheadline)
                        .foregroundColor(.secondary)

                    // æ›´æ–°æ—¶é—´
                    if let updateTime = hotTrendsManager.lastUpdateTime[contact.id] {
                        Text("æ›´æ–°æ—¶é—´: \(updateTime, formatter: timeFormatter)")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }

                Spacer()

                // çŠ¶æ€æŒ‡ç¤ºå™¨
                VStack(spacing: 4) {
                    Circle()
                        .fill(hotTrendsManager.isLoading[contact.id] == true ? Color.orange : Color.green)
                        .frame(width: 12, height: 12)

                    Text(hotTrendsManager.isLoading[contact.id] == true ? "æ›´æ–°ä¸­" : "å·²æ›´æ–°")
                        .font(.caption2)
                        .foregroundColor(.secondary)
                }
            }
            .padding()

            Divider()
        }
        .background(Color(.systemBackground))
    }

    private var timeFormatter: DateFormatter {
        let formatter = DateFormatter()
        formatter.dateFormat = "HH:mm"
        return formatter
    }
}

// MARK: - å¹³å°çƒ­æ¦œåˆ—è¡¨è§†å›¾
struct PlatformHotTrendsListView: View {
    let trends: HotTrendsList
    let onItemTap: (HotTrendItem) -> Void

    var body: some View {
        List(trends.items) { item in
            PlatformHotTrendItemRow(item: item) {
                onItemTap(item)
            }
            .listRowInsets(EdgeInsets(top: 8, leading: 16, bottom: 8, trailing: 16))
        }
        .listStyle(PlainListStyle())
    }
}

// MARK: - å¹³å°çƒ­æ¦œé¡¹ç›®è¡Œè§†å›¾
struct PlatformHotTrendItemRow: View {
    let item: HotTrendItem
    let onTap: () -> Void

    var body: some View {
        Button(action: onTap) {
            HStack(spacing: 12) {
                // æ’å
                Text(item.displayRank)
                    .font(.headline)
                    .fontWeight(.bold)
                    .foregroundColor(item.isTopThree ? .orange : .secondary)
                    .frame(width: 30, alignment: .center)

                VStack(alignment: .leading, spacing: 4) {
                    // æ ‡é¢˜
                    Text(item.title)
                        .font(.headline)
                        .fontWeight(.medium)
                        .foregroundColor(.primary)
                        .lineLimit(2)

                    // æè¿°
                    if let description = item.description {
                        Text(description)
                            .font(.subheadline)
                            .foregroundColor(.secondary)
                            .lineLimit(1)
                    }

                    // åº•éƒ¨ä¿¡æ¯
                    HStack {
                        if let category = item.category {
                            Text(category)
                                .font(.caption)
                                .padding(.horizontal, 8)
                                .padding(.vertical, 2)
                                .background(Color(.systemGray5))
                                .cornerRadius(4)
                        }

                        Spacer()

                        if let hotValue = item.hotValue {
                            Text(hotValue)
                                .font(.caption)
                                .foregroundColor(.orange)
                        }
                    }
                }

                Spacer()

                // ç®­å¤´æŒ‡ç¤ºå™¨
                Image(systemName: "chevron.right")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            .padding(.vertical, 4)
        }
        .buttonStyle(PlainButtonStyle())
    }
}

// MARK: - å¹³å°åŠ è½½è§†å›¾
struct PlatformLoadingView: View {
    var body: some View {
        VStack(spacing: 16) {
            ProgressView()
                .scaleEffect(1.5)

            Text("æ­£åœ¨è·å–çƒ­æ¦œæ•°æ®...")
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
}

// MARK: - å¹³å°ç©ºçŠ¶æ€è§†å›¾
struct PlatformEmptyStateView: View {
    let contact: AIContact
    let onBack: () -> Void    let onRetry: () -> Void

    var body: some View {
        VStack(spacing: 20) {
            Image(systemName: "exclamationmark.triangle")
                .font(.system(size: 48))
                .foregroundColor(.orange)

            Text("æš‚æ— çƒ­æ¦œæ•°æ®")
                .font(.headline)

            Text("è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•")
                .font(.subheadline)
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)

            Button("é‡æ–°åŠ è½½") {
                onRetry()
            }
            .buttonStyle(.borderedProminent)
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
        .padding()
    }
}

// MARK: - å¹³å°é¡¹ç›®è¯¦æƒ…è§†å›¾
struct PlatformItemDetailView: View {
    let item: HotTrendItem
    let contact: AIContact
    let onBack: () -> Void    @Environment(\.presentationMode) var presentationMode

    var body: some View {
        NavigationView {
            ScrollView {
                VStack(alignment: .leading, spacing: 20) {
                    // æ’åå’Œçƒ­åº¦
                    HStack {
                        Text(item.displayRank)
                            .font(.largeTitle)
                            .fontWeight(.bold)
                            .foregroundColor(item.isTopThree ? .orange : .secondary)

                        Spacer()

                        if let hotValue = item.hotValue {
                            Text(hotValue)
                                .font(.headline)
                                .foregroundColor(.orange)
                                .padding(.horizontal, 12)
                                .padding(.vertical, 6)
                                .background(Color.orange.opacity(0.1))
                                .cornerRadius(8)
                        }
                    }

                    // æ ‡é¢˜
                    Text(item.title)
                        .font(.title2)
                        .fontWeight(.bold)
                        .lineLimit(nil)

                    // æè¿°
                    if let description = item.description {
                        Text(description)
                            .font(.body)
                            .foregroundColor(.secondary)
                            .lineLimit(nil)
                    }

                    // å¹³å°å’Œåˆ†ç±»ä¿¡æ¯
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Text("æ¥æº:")
                                .font(.subheadline)
                                .foregroundColor(.secondary)

                            HStack(spacing: 4) {
                                Image(systemName: contact.avatar)
                                    .foregroundColor(contact.color)
                                Text(contact.name)
                            }
                            .font(.subheadline)
                        }

                        if let category = item.category {
                            HStack {
                                Text("åˆ†ç±»:")
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)

                                Text(category)
                                    .font(.subheadline)
                                    .padding(.horizontal, 8)
                                    .padding(.vertical, 2)
                                    .background(Color(.systemGray5))
                                    .cornerRadius(4)
                            }
                        }

                        HStack {
                            Text("æ—¶é—´:")
                                .font(.subheadline)
                                .foregroundColor(.secondary)

                            Text(item.timestamp, formatter: detailTimeFormatter)
                                .font(.subheadline)
                        }
                    }

                    // æ“ä½œæŒ‰é’®
                    VStack(spacing: 12) {
                        if let urlString = item.url, let url = URL(string: urlString) {
                            Button(action: {
                                UIApplication.shared.open(url)
                            }) {
                                HStack {
                                    Image(systemName: "link")
                                    Text("æ‰“å¼€åŸé“¾æ¥")
                                }
                                .frame(maxWidth: .infinity)
                                .padding()
                                .background(Color.blue)
                                .foregroundColor(.white)
                                .cornerRadius(10)
                            }
                        }

                        Button(action: {
                            shareContent()
                        }) {
                            HStack {
                                Image(systemName: "square.and.arrow.up")
                                Text("åˆ†äº«")
                            }
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color(.systemGray5))
                            .foregroundColor(.primary)
                            .cornerRadius(10)
                        }
                    }

                    Spacer()
                }
                .padding()
            }
            .navigationTitle("çƒ­æ¦œè¯¦æƒ…")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                trailing: Button("å…³é—­") {
                    presentationMode.wrappedValue.dismiss()
                }
            )
        }
    }

    private var detailTimeFormatter: DateFormatter {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd HH:mm"
        return formatter
    }

    private func shareContent() {
        let shareText = "\(item.title)\n\n\(item.description ?? "")\n\næ¥è‡ª: \(contact.name)"
        let activityVC = UIActivityViewController(activityItems: [shareText], applicationActivities: nil)

        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
           let window = windowScene.windows.first {
            window.rootViewController?.present(activityVC, animated: true)
        }
    }
}



struct ChatMessageRow: View {
    let message: ChatMessage
    @ObservedObject private var hotTrendsManager = MockHotTrendsManager.shared

    var body: some View {
        HStack {
            if message.isFromUser {
                Spacer()

                VStack(alignment: .trailing, spacing: 4) {
                    Text(message.content)
                        .padding(.horizontal, 16)
                        .padding(.vertical, 10)
                        .background(Color.blue)
                        .foregroundColor(.white)
                        .cornerRadius(18)
                        .frame(maxWidth: UIScreen.main.bounds.width * 0.7, alignment: .trailing)

                    Text(formatTime(message.timestamp))
                        .font(.caption2)
                        .foregroundColor(.secondary)
                }
            } else {
                VStack(alignment: .leading, spacing: 8) {
                    // æ¶ˆæ¯å†…å®¹
                    Text(message.content)
                        .padding(.horizontal, 16)
                        .padding(.vertical, 10)
                        .background(Color(.systemGray5))
                        .foregroundColor(.primary)
                        .cornerRadius(18)
                        .frame(maxWidth: UIScreen.main.bounds.width * 0.8, alignment: .leading)

                    // å¦‚æœæ˜¯å¹³å°æ¶ˆæ¯ä¸”æœ‰çƒ­æ¦œæ•°æ®ï¼Œæ˜¾ç¤ºçƒ­æ¦œé¢„è§ˆ
                    if let aiSource = message.aiSource,
                       let trends = hotTrendsManager.getHotTrends(for: getPlatformId(from: aiSource)),
                       !trends.items.isEmpty {
                        HotTrendsPreviewCard(trends: trends, platformName: aiSource)
                    }

                    // æ¶ˆæ¯æ“ä½œæŒ‰é’®
                    if !message.actions.isEmpty {
                        MessageActionsView(actions: message.actions, platformId: getPlatformId(from: message.aiSource))
                    }

                    // æ—¶é—´å’Œæ¥æº
                    HStack {
                        Text(formatTime(message.timestamp))
                            .font(.caption2)
                            .foregroundColor(.secondary)

                        if let aiSource = message.aiSource {
                            Text("â€¢ \(aiSource)")
                                .font(.caption2)
                                .foregroundColor(.secondary)
                        }
                    }
                }

                Spacer()
            }
        }
    }

    private func getPlatformId(from aiSource: String?) -> String {
        guard let source = aiSource else { return "" }
        return source
    }
    
    private func formatTime(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.timeStyle = .short
        return formatter.string(from: date)
    }
}

struct ChatView_Previews: PreviewProvider {
    static var previews: some View {
        NavigationView {
            ChatView(contact: AIContact(
                id: "deepseek",
                name: "DeepSeek",
                description: "DeepSeek AIåŠ©æ‰‹",
                model: "deepseek-chat",
                avatar: "brain.head.profile",
                isOnline: true,
                apiEndpoint: "https://api.deepseek.com",
                requiresApiKey: true,
                supportedFeatures: [.textGeneration]
            ))
        }
    }
}

// MARK: - çƒ­æ¦œé¢„è§ˆå¡ç‰‡
struct HotTrendsPreviewCard: View {
    let trends: HotTrendsList
    let platformName: String
    @State private var showingFullList = false

    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            // å¡ç‰‡å¤´éƒ¨
            HStack {
                Text("ğŸ”¥ \(platformName) çƒ­æ¦œ")
                    .font(.headline)
                    .fontWeight(.semibold)

                Spacer()

                Text("\(trends.items.count)æ¡")
                    .font(.caption)
                    .foregroundColor(.secondary)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 2)
                    .background(Color(.systemGray5))
                    .cornerRadius(4)
            }

            // çƒ­æ¦œé¢„è§ˆï¼ˆæ˜¾ç¤ºå‰3æ¡ï¼‰
            VStack(spacing: 8) {
                ForEach(trends.items.prefix(3)) { item in
                    HotTrendPreviewRow(item: item)
                }
            }

            // æŸ¥çœ‹æ›´å¤šæŒ‰é’®
            if trends.items.count > 3 {
                Button(action: {
                    showingFullList = true
                }) {
                    HStack {
                        Text("æŸ¥çœ‹å…¨éƒ¨ \(trends.items.count) æ¡çƒ­æ¦œ")
                            .font(.subheadline)
                            .fontWeight(.medium)

                        Spacer()

                        Image(systemName: "chevron.right")
                            .font(.caption)
                    }
                    .foregroundColor(.blue)
                    .padding(.vertical, 8)
                }
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.05), radius: 2, x: 0, y: 1)
        .sheet(isPresented: $showingFullList) {
            PlatformHotTrendsFullListView(trends: trends, platformName: platformName)
        }
    }
}

// MARK: - çƒ­æ¦œé¢„è§ˆè¡Œ
struct HotTrendPreviewRow: View {
    let item: HotTrendItem

    var body: some View {
        HStack(spacing: 8) {
            // æ’å
            Text(item.displayRank)
                .font(.caption)
                .fontWeight(.bold)
                .foregroundColor(item.isTopThree ? .orange : .secondary)
                .frame(width: 20, alignment: .center)

            // æ ‡é¢˜
            Text(item.title)
                .font(.subheadline)
                .lineLimit(1)
                .foregroundColor(.primary)

            Spacer()

            // çƒ­åº¦å€¼
            if let hotValue = item.hotValue {
                Text(hotValue)
                    .font(.caption2)
                    .foregroundColor(.orange)
            }
        }
        .padding(.vertical, 2)
    }
}

// MARK: - æ¶ˆæ¯æ“ä½œæŒ‰é’®è§†å›¾
struct MessageActionsView: View {
    let actions: [MessageAction]
    let platformId: String?
    @ObservedObject private var hotTrendsManager = MockHotTrendsManager.shared

    var body: some View {
        HStack(spacing: 8) {
            ForEach(actions) { action in
                Button(action: {
                    handleAction(action)
                }) {
                    Text(action.title)
                        .font(.caption)
                        .fontWeight(.medium)
                        .foregroundColor(.blue)
                        .padding(.horizontal, 12)
                        .padding(.vertical, 6)
                        .background(Color.blue.opacity(0.1))
                        .cornerRadius(8)
                }
            }

            Spacer()
        }
    }

    private func handleAction(_ action: MessageAction) {
        switch action.type {
        case .refresh:
            if let platformId = platformId {
                hotTrendsManager.refreshHotTrends(for: platformId)
            }
        case .viewContent:
            // æ˜¾ç¤ºçƒ­æ¦œå†…å®¹
            if let platformId = platformId {
                NotificationCenter.default.post(
                    name: .showPlatformHotTrends,
                    object: platformId
                )
            }
        case .settings:
            // æ‰“å¼€è®¾ç½®
            print("æ‰“å¼€è®¾ç½®")
        case .share:
            // åˆ†äº«å†…å®¹
            print("åˆ†äº«å†…å®¹")
        case .openLink:
            // æ‰“å¼€é“¾æ¥
            print("æ‰“å¼€é“¾æ¥")
        }
    }
}

// MARK: - å¹³å°çƒ­æ¦œå®Œæ•´åˆ—è¡¨è§†å›¾
struct PlatformHotTrendsFullListView: View {
    let trends: HotTrendsList
    let platformName: String
    @Environment(\.presentationMode) var presentationMode

    var body: some View {
        NavigationView {
            List(trends.items) { item in
                PlatformHotTrendItemRow(item: item) {
                    handleItemTap(item)
                }
                .listRowInsets(EdgeInsets(top: 8, leading: 16, bottom: 8, trailing: 16))
            }
            .navigationTitle("\(platformName) çƒ­æ¦œ")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                trailing: Button("å…³é—­") {
                    presentationMode.wrappedValue.dismiss()
                }
            )
        }
    }

    private func handleItemTap(_ item: HotTrendItem) {
        // å°è¯•æ‰“å¼€æ·±åº¦é“¾æ¥
        if let urlString = item.url, let url = URL(string: urlString) {
            if UIApplication.shared.canOpenURL(url) {
                UIApplication.shared.open(url)
                presentationMode.wrappedValue.dismiss()
                return
            }
        }

        // å¦‚æœæ— æ³•æ‰“å¼€é“¾æ¥ï¼Œæ˜¾ç¤ºè¯¦æƒ…
        print("æ˜¾ç¤ºçƒ­æ¦œé¡¹ç›®è¯¦æƒ…: \(item.title)")
    }
}
